<UserControl x:Class="LanguageSchoolERP.App.Views.StudentsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d">
    <Grid Margin="2">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Background="{StaticResource Brush.SurfaceAlt}" BorderBrush="{StaticResource Brush.Border}" BorderThickness="1" CornerRadius="10" Padding="14" Margin="0,0,0,14">
            <DockPanel>
            <TextBlock Text="Students" FontSize="24" FontWeight="SemiBold" DockPanel.Dock="Left"/>

			<StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
				<Button Content="New Student" Width="120" Margin="0,0,8,0" Command="{Binding NewStudentCommand}"/>

				<ComboBox Width="130"
						  Margin="0,0,8,0"
						  VerticalContentAlignment="Center"
						  ItemsSource="{Binding StudentStatusFilters}"
						  SelectedItem="{Binding SelectedStudentStatusFilter, Mode=TwoWay}"/>

				<TextBox Width="300"
						 Margin="0,0,8,0"
						 VerticalContentAlignment="Center"
						 Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
						 ToolTip="Search by name, phone, email"/>

				<Button Content="Refresh" Width="90" Command="{Binding RefreshCommand}"/>
			</StackPanel>

		</DockPanel>
        </Border>

        <!-- List -->
        <Border Grid.Row="1" BorderBrush="{StaticResource Brush.Border}" BorderThickness="1" CornerRadius="10" Padding="12" Background="White">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding Students}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border BorderBrush="{StaticResource Brush.Border}" BorderThickness="1" CornerRadius="10" Padding="12" Margin="0,0,0,12" Background="#FBFDFF">
                                <StackPanel>

                                    <!-- Student summary row -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <StackPanel>
                                            <TextBlock Text="{Binding FullName}" FontSize="16" FontWeight="SemiBold"/>
                                            <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                <TextBlock Text="{Binding ContactLine}" Foreground="{StaticResource Brush.TextSecondary}"/>
                                                <TextBlock Text="  •  " Foreground="#999999"/>
                                                <TextBlock Text="{Binding YearLabel}" Foreground="{StaticResource Brush.TextSecondary}"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Balance -->
                                        <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                                            <TextBlock Text="Balance" Foreground="{StaticResource Brush.TextSecondary}" FontSize="12" HorizontalAlignment="Right"/>
                                            <TextBlock Text="{Binding BalanceText}" FontSize="16" FontWeight="SemiBold" HorizontalAlignment="Right"/>
                                        </StackPanel>

                                        <!-- Active badge -->
                                        <Border Grid.Column="2" Margin="12,0,0,0" Padding="8,3"
                                                CornerRadius="999"
                                                Background="{Binding ActiveBadgeBackground}"
                                                VerticalAlignment="Center">
                                            <TextBlock Text="{Binding ActiveBadgeText}" Foreground="White" FontSize="12"/>
                                        </Border>

                                        <!-- Overdue badge -->
                                        <Border Grid.Column="3" Margin="12,0,0,0" Padding="8,3"
                                                CornerRadius="999"
                                                Background="{Binding OverdueBadgeBackground}"
                                                VerticalAlignment="Center">
                                            <TextBlock Text="{Binding OverdueBadgeText}" Foreground="White" FontSize="12"/>
                                        </Border>

                                        <!-- Pending contract badge -->
                                        <Border Grid.Column="4" Margin="12,0,0,0" Padding="8,3"
                                                CornerRadius="999"
                                                Background="{Binding PendingContractBadgeBackground}"
                                                VerticalAlignment="Center"
                                                Visibility="{Binding PendingContractVisibility}">
                                            <TextBlock Text="{Binding PendingContractBadgeText}" Foreground="White" FontSize="12"/>
                                        </Border>
										
										<Button Grid.Column="5"
												Margin="12,0,0,0"
												Width="90" Height="32"
												Content="Open"
												Command="{Binding DataContext.OpenStudentCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
												CommandParameter="{Binding StudentId}"
												VerticalAlignment="Center"/>

										<!-- Expand caret -->
                                        <ToggleButton Grid.Column="6" Margin="12,0,0,0"
                                                      Width="36" Height="36"
                                                      IsChecked="{Binding IsExpanded, Mode=TwoWay}"
                                                      Content="⌄"
                                                      FontSize="18"
                                                      VerticalAlignment="Center"/>
                                    </Grid>

                                    <!-- Expand enrollments -->
                                    <Border Margin="0,10,0,0"
                                            BorderBrush="{StaticResource Brush.Border}" BorderThickness="1"
                                            CornerRadius="10"
                                            Padding="10"
                                            Visibility="{Binding ExpandedVisibility}">
                                        <StackPanel>
                                            <TextBlock Text="Enrollments (this academic year)" Foreground="{StaticResource Brush.TextSecondary}" Margin="0,0,0,8"/>

                                            <ItemsControl ItemsSource="{Binding Enrollments}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid Margin="0,0,0,6">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>

                                                            <StackPanel>
                                                                <TextBlock Text="{Binding Title}" FontWeight="SemiBold"/>
                                                                <TextBlock Text="{Binding Details}" Foreground="{StaticResource Brush.TextSecondary}" FontSize="12"/>
                                                            </StackPanel>

                                                            <TextBlock Grid.Column="1" Margin="12,0,0,0"
                                                                       Text="{Binding AgreementText}" HorizontalAlignment="Right"/>

                                                            <TextBlock Grid.Column="2" Margin="12,0,0,0"
                                                                       Text="{Binding PaidText}" HorizontalAlignment="Right"/>

                                                            <TextBlock Grid.Column="3" Margin="12,0,0,0"
                                                                       Text="{Binding BalanceText}" FontWeight="SemiBold" HorizontalAlignment="Right"/>
                                                        </Grid>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Border>

                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>
    </Grid>
</UserControl>
